name: RkeApply
on:
  workflow_dispatch:
    inputs:
      sha:
        description: The SHA of a git commit to apply.
        required: true

jobs:

  Rke-Apply:
    runs-on: ubuntu-20.04

    env:
      GCP_HOST: sheep-dog
      GCP_PORT: 15000
      SUCCESS_URL: gs://bucket-of-dog-treats/gcp-integration

    steps:

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@master
        with:
          version: 312.0.0
          project_id: ${{ secrets.GCP_PROJECT }}
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          export_default_credentials: true

      - name: Test Google Cloud SDK and setup IAP tunnel.
        run: |
          gcloud config set compute/zone ${{ secrets.GCP_COMPUTE_ZONE }}
          gcloud compute start-iap-tunnel \
            ${{ env.GCP_HOST }} ${{ env.GCP_PORT }} \
            --local-host-port localhost:${{ env.GCP_PORT }} &
          sh -c 'until nc -z localhost ${{ env.GCP_PORT }} ; do sleep 1 ; done'

      - name: Check out source code
        uses: actions/checkout@v2

      - name: Pretend to work and then delete success hashes in GCP bucket.
        run: |
          echo "We will assume that 'rke up' ran successfully."
          echo "--- deleting git hashes of all previous RkeUp runs ---
          gsutil rm $SUCCESS_URL/hash.RkeUp.*

